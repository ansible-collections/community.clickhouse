####################################################################
# WARNING: These are designed specifically for Ansible tests       #
# and should not be used as examples of how to write Ansible roles #
####################################################################

# Test 1 - Basic creation in check mode
- name: Test 1 - Create a test quota in check mode
  register: result
  check_mode: true
  community.clickhouse.clickhouse_quota:
    state: present
    name: test_quota

- name: Test 1 - Check the return values
  ansible.builtin.assert:
    that:
    - result is changed
    - result.executed_statements == ['CREATE QUOTA \'test_quota\'']

- name: Test 1 - Check the role was not created in check mode
  register: result
  community.clickhouse.clickhouse_client:
    execute: "SELECT name FROM system.quotas WHERE name = 'test_quota'"

- name: Test 1 - Verify that the role is not present
  ansible.builtin.assert:
    that:
    - result.result == []

# Test 2 - Basic creation with limits in check mode
- name: Test 2 - Create a test quota in check mode
  register: result
  check_mode: true
  community.clickhouse.clickhouse_quota:
    state: present
    name: test_quota
    limits:
      - interval: 5 minute
        max:
          queries: 10

- name: Test 2 - Check the return values
  ansible.builtin.assert:
    that:
    - result is changed
    - result.executed_statements == ['CREATE QUOTA \'test_quota\' FOR INTERVAL 5 minute MAX queries = 10']

- name: Test 2 - Check the role was not created in check mode
  register: result
  community.clickhouse.clickhouse_client:
    execute: "SELECT name FROM system.quotas WHERE name = 'test_quota'"

- name: Test 2 - Verify that the role is not present
  ansible.builtin.assert:
    that:
    - result.result == []

# Test 3 - Basic creation with limits and apply_to in check mode
- name: Test 3 - Create a test quota with limits and apply_to in check mode
  register: result
  check_mode: true
  community.clickhouse.clickhouse_quota:
    state: present
    name: test_quota
    limits:
      - interval: 5 minute
        max:
          queries: 100
          execution_time: 600
    apply_to:
      - default

- name: Test 3 - Check the return values
  ansible.builtin.assert:
    that:
    - result is changed
    - result.executed_statements == ['CREATE QUOTA \'test_quota\' FOR INTERVAL 5 minute MAX queries = 100, execution_time = 600.0 TO default']

- name: Test 3 - Check the role was not created in check mode
  register: result
  community.clickhouse.clickhouse_client:
    execute: "SELECT name FROM system.quotas WHERE name = 'test_quota'"

- name: Test 3 - Verify that the role is not present
  ansible.builtin.assert:
    that:
    - result.result == []

# Test 4 - Basic creation with limits and apply_to_mode = all in check mode
- name: Test 4 - Create a test quota with limits and apply_to_mode = all in check mode
  register: result
  check_mode: true
  community.clickhouse.clickhouse_quota:
    state: present
    name: test_quota
    limits:
      - interval: 5 minute
        tracking_only: true
    apply_to_mode: all

- name: Test 4 - Check the return values
  ansible.builtin.assert:
    that:
    - result is changed
    - result.executed_statements == ['CREATE QUOTA \'test_quota\' FOR INTERVAL 5 minute TRACKING ONLY TO ALL']

- name: Test 4 - Check the role was not created in check mode
  register: result
  community.clickhouse.clickhouse_client:
    execute: "SELECT name FROM system.quotas WHERE name = 'test_quota'"

- name: Test 4 - Verify that the role is not present
  ansible.builtin.assert:
    that:
    - result.result == []

# Test 5 - Basic creation with limits and apply_to_mode = all_except_listed in check mode
- name: Test 5 - Create a test quota with limits and apply_to_mode = all_except_listed in check mode
  register: result
  check_mode: true
  community.clickhouse.clickhouse_quota:
    state: present
    name: test_quota
    limits:
      - interval: 5 minute
        no_limits: true
    apply_to_mode: all_except_listed

- name: Test 5 - Check the return values
  ansible.builtin.assert:
    that:
    - result is changed
    - result.executed_statements == ['CREATE QUOTA \'test_quota\' FOR INTERVAL 5 minute NO LIMITS TO ALL']

- name: Test 5 - Check the role was not created in check mode
  register: result
  community.clickhouse.clickhouse_client:
    execute: "SELECT name FROM system.quotas WHERE name = 'test_quota'"

- name: Test 5 - Verify that the role is not present
  ansible.builtin.assert:
    that:
    - result.result == []

# Test 6 - Basic creation with limits and apply_to_mode = all_except_listed in check mode
- name: Test 6 - Create a test quota with limits and apply_to_mode = all_except_listed in check mode
  register: result
  check_mode: true
  community.clickhouse.clickhouse_quota:
    state: present
    name: test_quota
    limits:
      - interval: 5 minute
        max:
          failed_sequential_authentications: 5
    apply_to_mode: all_except_listed
    apply_to:
      - admin
      - CURRENT_USER

- name: Test 6 - Check the return values
  ansible.builtin.assert:
    that:
    - result is changed
    - result.executed_statements == ['CREATE QUOTA \'test_quota\' FOR INTERVAL 5 minute MAX failed_sequential_authentications = 5 TO ALL EXCEPT admin, CURRENT_USER']

- name: Test 6 - Check the role was not created in check mode
  register: result
  community.clickhouse.clickhouse_client:
    execute: "SELECT name FROM system.quotas WHERE name = 'test_quota'"

- name: Test 6 - Verify that the role is not present
  ansible.builtin.assert:
    that:
    - result.result == []

# Test 7 - Basic creation with keyed_by, limits and apply_to_mode = all_except_listed in check mode
- name: Test 7 - Create a test quota with keyed_by, limits and apply_to_mode = all_except_listed in check mode
  register: result
  check_mode: true
  community.clickhouse.clickhouse_quota:
    state: present
    name: test_quota
    keyed_by: user_name
    limits:
      - interval: 5 minute
        randomized_start: true
        max:
          queries: 100
          execution_time: 300.5
    apply_to_mode: all

- name: Test 7 - Check the return values
  ansible.builtin.assert:
    that:
    - result is changed
    - result.executed_statements == ['CREATE QUOTA \'test_quota\' KEYED BY user_name FOR RANDOMIZED INTERVAL 5 minute MAX queries = 100, execution_time = 300.5 TO ALL']

- name: Test 7 - Check the role was not created in check mode
  register: result
  community.clickhouse.clickhouse_client:
    execute: "SELECT name FROM system.quotas WHERE name = 'test_quota'"

- name: Test 7 - Verify that the role is not present
  ansible.builtin.assert:
    that:
    - result.result == []

# Test 8 - Basic creation with cluster, keyed_by and limits in check mode
- name: Test 8 - Create a test quota with cluster, keyed_by, limits in check mode
  register: result
  check_mode: true
  community.clickhouse.clickhouse_quota:
    state: present
    name: test_quota
    cluster: test_cluster
    keyed_by: user_name
    limits:
      - interval: 5 minute
        randomized_start: true
        max:
          execution_time: 10.2
      - interval: 1 day
        max:
          query_selects: 10
          query_inserts: 10
    apply_to: CURRENT_USER

- name: Test 8 - Check the return values
  ansible.builtin.assert:
    that:
    - result is changed
    - result.executed_statements == ['CREATE QUOTA \'test_quota\' ON CLUSTER \'test_cluster\' KEYED BY user_name FOR RANDOMIZED INTERVAL 5 minute MAX execution_time = 10.2, FOR INTERVAL 1 day MAX query_selects = 10, query_inserts = 10 TO CURRENT_USER']

- name: Test 8 - Check the role was not created in check mode
  register: result
  community.clickhouse.clickhouse_client:
    execute: "SELECT name FROM system.quotas WHERE name = 'test_quota'"

- name: Test 8 - Verify that the role is not present
  ansible.builtin.assert:
    that:
    - result.result == []

# Test 9 - Negative test that you can't specify apply_to_mode == all and a list of users
- name: Test 9 - Negative test that you can't specify apply_to_mode == all and a list of users
  register: result
  check_mode: true
  ignore_errors: true
  community.clickhouse.clickhouse_quota:
    state: present
    name: test_quota
    apply_to: CURRENT_USER
    apply_to_mode: all

- name: Test 9 - Check the return values
  ansible.builtin.assert:
    that:
    - result is failed

# Test 10 - Actual test with basic limits
- name: Test 10 - Actual test with basic limits
  register: result
  community.clickhouse.clickhouse_quota:
    name: test_quota
    keyed_by: user_name
    limits:
      - interval: 5 minute
        randomized_start: true
        max:
          queries: 100
    apply_to: default

- name: Test 10 - Check the return values
  ansible.builtin.assert:
    that:
    - result is changed
    - result.executed_statements == ['CREATE QUOTA \'test_quota\' KEYED BY user_name FOR RANDOMIZED INTERVAL 5 minute MAX queries = 100 TO default']

- name: Test 10 - Check the role was actually created
  register: result
  community.clickhouse.clickhouse_client:
    execute: "SELECT name FROM system.quotas WHERE name = 'test_quota'"

- name: Test 10 - Verify that the role is present
  ansible.builtin.assert:
    that:
    - result.result == [['test_quota']]

- name: Test 10 - Actually delete the quota
  register: result
  community.clickhouse.clickhouse_quota:
    name: test_quota
    state: absent

- name: Test 10 - Check the return values
  ansible.builtin.assert:
    that:
    - result is changed
    - result.executed_statements == ['DROP QUOTA \'test_quota\'']

- name: Test 10 - Check the role was actually deleted
  register: result
  community.clickhouse.clickhouse_client:
    execute: "SELECT name FROM system.quotas WHERE name = 'test_quota'"

- name: Test 10 - Verify that the role is no longer present
  ansible.builtin.assert:
    that:
    - result.result == []

# Test 11 - Alter quota
- name: Test 11 - Create quota
  register: result
  community.clickhouse.clickhouse_quota:
    name: tést quota
    keyed_by: client_key,user_name
    limits:
      - interval: 5 minute
        randomized_start: true
        max:
          queries: 100
          execution_time: 1.1
    apply_to: default

- name: Test 11 - Check the return values
  ansible.builtin.assert:
    that:
    - result is changed
    - result.executed_statements == ['CREATE QUOTA \'tést quota\' KEYED BY client_key,user_name FOR RANDOMIZED INTERVAL 5 minute MAX queries = 100, execution_time = 1.1 TO default']

- name: Test 11 - Check the role was actually created
  register: result
  community.clickhouse.clickhouse_client:
    execute: "SELECT name FROM system.quotas WHERE name = 'tést quota'"

- name: Test 11 - Verify that the role is present
  ansible.builtin.assert:
    that:
    - result.result == [['tést quota']]

- name: Test 11 - Alter the quota
  register: result
  community.clickhouse.clickhouse_quota:
    name: tést quota
    keyed_by: client_key,user_name
    limits:
      - interval: 5 minute
        randomized_start: true
        max:
          queries: 100
          execution_time: 1.1
      - interval: 1 minute
        max:
          errors: 10
    apply_to: default

- name: Test 11 - Check the return values
  ansible.builtin.assert:
    that:
    - result is changed
    - result.executed_statements == ['ALTER QUOTA \'tést quota\' KEYED BY client_key,user_name FOR RANDOMIZED INTERVAL 5 minute MAX queries = 100, execution_time = 1.1, FOR INTERVAL 1 minute MAX errors = 10 TO default']

- name: Test 11 - Check idempotency
  register: result
  community.clickhouse.clickhouse_quota:
    name: tést quota
    keyed_by: client_key,user_name
    limits:
      - interval: 5 minute
        randomized_start: true
        max:
          queries: 100
          execution_time: 1.1
      - interval: 1 minute
        max:
          errors: 10
    apply_to: default

- name: Test 11 - Check the return values
  ansible.builtin.assert:
    that:
    - result is not changed
    - result.executed_statements == []

- name: Test 11 - Actually delete the quota
  register: result
  community.clickhouse.clickhouse_quota:
    name: tést quota
    state: absent

- name: Test 11 - Check the return values
  ansible.builtin.assert:
    that:
    - result is changed
    - result.executed_statements == ['DROP QUOTA \'tést quota\'']

- name: Test 11 - Check the role was actually deleted
  register: result
  community.clickhouse.clickhouse_client:
    execute: "SELECT name FROM system.quotas WHERE name = 'tést quota'"

- name: Test 11 - Verify that the role is no longer present
  ansible.builtin.assert:
    that:
    - result.result == []
